# APEX.BUILD Render Blueprint
# Deploy infrastructure as code on Render
# https://render.com/docs/blueprint-spec

services:
  # ============================================
  # Backend API Service
  # ============================================
  - type: web
    name: apex-api
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    region: oregon
    plan: starter
    branch: main
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: 8080
      - key: GIN_MODE
        value: release
      - key: LOG_FORMAT
        value: json
      - key: LOG_LEVEL
        value: info
      - key: DATABASE_URL
        fromDatabase:
          name: apex-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: apex-redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: SECRETS_MASTER_KEY
        generateValue: true
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
    autoDeploy: true
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 80
      targetCPUPercent: 80

  # ============================================
  # Frontend Static Site
  # ============================================
  - type: web
    name: apex-frontend
    runtime: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    region: oregon
    plan: starter
    branch: main
    healthCheckPath: /health
    buildCommand: ""
    envVars:
      - key: VITE_API_URL
        value: https://apex-api.onrender.com/api/v1
      - key: VITE_WS_URL
        value: wss://apex-api.onrender.com/ws
      - key: NODE_ENV
        value: production
    autoDeploy: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin

  # ============================================
  # Background Worker (optional)
  # ============================================
  # - type: worker
  #   name: apex-worker
  #   runtime: docker
  #   dockerfilePath: ./backend/Dockerfile.worker
  #   dockerContext: ./backend
  #   region: oregon
  #   plan: starter
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: apex-db
  #         property: connectionString

databases:
  # ============================================
  # PostgreSQL Database
  # ============================================
  - name: apex-db
    plan: starter
    region: oregon
    postgresMajorVersion: 15
    ipAllowList: []  # Allow all IPs (can restrict in production)
    # databaseName: apex_build
    # user: apex_user

# ============================================
# Redis Cache
# ============================================
# Note: Render Redis requires Pro plan or higher
# For starter plans, consider using Upstash Redis

# Preview Environments (for PRs)
previewsEnabled: true
previewsExpireAfterDays: 7
