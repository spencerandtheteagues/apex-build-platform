# APEX.BUILD Render Blueprint
# Deploy infrastructure as code on Render
# https://render.com/docs/blueprint-spec

services:
  # ============================================
  # Backend API Service
  # ============================================
  - type: web
    name: apex-api
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    region: oregon
    plan: starter
    branch: main
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: 8080
      - key: GIN_MODE
        value: release
      - key: LOG_FORMAT
        value: json
      - key: LOG_LEVEL
        value: info
      - key: DATABASE_URL
        fromDatabase:
          name: apex-db
          property: connectionString
      - key: FRONTEND_URL
        value: https://apex-frontend-gigq.onrender.com
      - key: CORS_ORIGINS
        value: https://apex-frontend-gigq.onrender.com,https://apex.build
      - key: REDIS_URL
        sync: false  # Use Upstash Redis (Render free tier has no managed Redis)
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: SECRETS_MASTER_KEY
        generateValue: true
      - key: ADMIN_SEED_PASSWORD
        sync: false
      - key: SPENCER_SEED_PASSWORD
        sync: false
      - key: EXECUTION_FORCE_CONTAINER
        value: "false"  # Render doesn't support Docker-in-Docker; use process sandbox
      - key: BUILD_MAX_REQUESTS
        value: "80"
      - key: BUILD_MAX_REQUESTS_FAST
        value: "80"
      - key: BUILD_MAX_REQUESTS_FULL
        value: "150"
      - key: BUILD_TIMEOUT_FAST_SECONDS
        value: "300"
      - key: BUILD_TIMEOUT_FULL_SECONDS
        value: "900"
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
    autoDeploy: true

  # ============================================
  # Frontend Static Site
  # ============================================
  - type: web
    name: apex-frontend
    runtime: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    region: oregon
    plan: starter
    branch: main
    healthCheckPath: /health
    envVars:
      - key: VITE_API_URL
        value: https://apex-backend-5ypy.onrender.com/api/v1
      - key: VITE_WS_URL
        value: wss://apex-backend-5ypy.onrender.com/ws
      - key: NODE_ENV
        value: production
    autoDeploy: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin

  # ============================================
  # Background Worker (optional)
  # ============================================
  # - type: worker
  #   name: apex-worker
  #   runtime: docker
  #   dockerfilePath: ./backend/Dockerfile.worker
  #   dockerContext: ./backend
  #   region: oregon
  #   plan: starter
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: apex-db
  #         property: connectionString

databases:
  # ============================================
  # PostgreSQL Database
  # ============================================
  - name: apex-db
    plan: starter
    region: oregon
    postgresMajorVersion: 15
    ipAllowList: []  # Allow all IPs (can restrict in production)
    # databaseName: apex_build
    # user: apex_user

# ============================================
# Redis Cache - Use Upstash (free tier)
# ============================================
# Render managed Redis requires Pro plan or higher.
# Set REDIS_URL manually in each service's env vars using Upstash:
#   1. Create free Redis at https://upstash.com
#   2. Copy the Redis URL
#   3. Set REDIS_URL in Render Dashboard → apex-api → Environment

# Preview Environments (for PRs)
previewsEnabled: true
previewsExpireAfterDays: 7
