# APEX.BUILD Runtime workers (sandbox-v2 service, always-on controller, E2E smoke cronjob)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apex-runtime-workers-config
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: runtime-workers
data:
  SANDBOX_V2_ISOLATION: "gvisor"
  SANDBOX_V2_GVISOR_RUNTIME: "runsc"
  SANDBOX_V2_ENABLED: "true"
  EXECUTION_SANDBOX_V2: "true"
  EXECUTION_SANDBOX_V2_PREFER: "true"
  SANDBOX_V2_PACKAGE_CACHE_ROOT: "/cache/pkg"
  SANDBOX_V2_WORKSPACE_ROOT: "/tmp/sandbox-v2"
  ALWAYSON_RECONCILE_INTERVAL: "45s"
---
apiVersion: v1
kind: Service
metadata:
  name: apex-sandbox-v2
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: sandbox-v2
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: sandbox-v2
  ports:
    - name: http
      port: 8085
      targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-sandbox-v2
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: sandbox-v2
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: apex-build
      app.kubernetes.io/component: sandbox-v2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: apex-build
        app.kubernetes.io/component: sandbox-v2
    spec:
      serviceAccountName: apex-runtime-workers
      automountServiceAccountToken: false
      containers:
        - name: sandbox-v2
          image: apex-build/sandbox-v2:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8085
          envFrom:
            - configMapRef:
                name: apex-runtime-workers-config
          env:
            - name: DOCKER_HOST
              value: unix:///var/run/docker.sock
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "2"
              memory: 2Gi
          volumeMounts:
            - name: docker-sock
              mountPath: /var/run/docker.sock
              readOnly: true
            - name: sandbox-cache
              mountPath: /cache/pkg
            - name: sandbox-tmp
              mountPath: /tmp
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
      volumes:
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
            type: Socket
        - name: sandbox-cache
          persistentVolumeClaim:
            claimName: apex-sandbox-v2-cache
        - name: sandbox-tmp
          emptyDir: {}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: apex-sandbox-v2-cache
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: sandbox-v2
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-alwayson-controller
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: alwayson-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: apex-build
      app.kubernetes.io/component: alwayson-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: apex-build
        app.kubernetes.io/component: alwayson-controller
    spec:
      serviceAccountName: apex-runtime-workers
      automountServiceAccountToken: false
      containers:
        - name: alwayson-controller
          image: apex-build/alwayson-controller:latest
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: apex-runtime-workers-config
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: apex-backend-secrets
                  key: DATABASE_URL
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: apex-backend-secrets
                  key: REDIS_URL
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: apex-e2e-smoke
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: e2e-smoke
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: apex-build
            app.kubernetes.io/component: e2e-smoke
        spec:
          restartPolicy: Never
          serviceAccountName: apex-runtime-workers
          automountServiceAccountToken: false
          containers:
            - name: playwright
              image: mcr.microsoft.com/playwright:v1.55.0-jammy
              workingDir: /work/tests/e2e
              command:
                - sh
                - -lc
                - |
                  if [ ! -f package.json ]; then
                    echo "No tests/e2e bundle mounted. Bake tests into image or replace apex-e2e-tests-bundle ConfigMap.";
                    exit 0;
                  fi
                  npm ci && \
                    npm run generate && \
                    PLAYWRIGHT_BASE_URL=${PLAYWRIGHT_BASE_URL:-https://apex.build} \
                    PLAYWRIGHT_API_URL=${PLAYWRIGHT_API_URL:-https://apex.build} \
                    npx playwright test specs/generated --project=chromium
              env:
                - name: PLAYWRIGHT_BASE_URL
                  value: https://apex.build
                - name: PLAYWRIGHT_API_URL
                  value: https://apex.build
              volumeMounts:
                - name: e2e-tests
                  mountPath: /work/tests/e2e
              resources:
                requests:
                  cpu: 250m
                  memory: 512Mi
                limits:
                  cpu: "2"
                  memory: 2Gi
          volumes:
            - name: e2e-tests
              configMap:
                name: apex-e2e-tests-bundle
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apex-e2e-tests-bundle
  namespace: apex-build
  labels:
    app.kubernetes.io/name: apex-build
    app.kubernetes.io/component: e2e-smoke
data:
  README: |
    Mount a generated tests/e2e bundle in this ConfigMap or replace this CronJob with a CI runner.
    The root tests/e2e generator added in this Codex half is the source of truth for smoke specs.
