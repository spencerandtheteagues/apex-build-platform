apiVersion: v1
kind: ConfigMap
metadata:
  name: apex-backend-config
  namespace: apex-build
data:
  ENVIRONMENT: "production"
  GIN_MODE: "release"
  DB_SSL_MODE: "require"
  EXECUTION_TIMEOUT: "45s"
  EXECUTION_MEMORY_LIMIT: "1024MB"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-backend
  namespace: apex-build
spec:
  replicas: 4
  template:
    spec:
      containers:
        - name: backend
          env:
            - name: EXECUTION_FORCE_CONTAINER
              value: "true"
            - name: EXECUTION_SANDBOX_V2
              value: "true"
            - name: EXECUTION_SANDBOX_V2_PREFER
              value: "true"
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: "4"
              memory: 4Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-frontend
  namespace: apex-build
spec:
  replicas: 4
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-sandbox-v2
  namespace: apex-build
spec:
  replicas: 4
  template:
    spec:
      containers:
        - name: sandbox-v2
          imagePullPolicy: Always
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "4"
              memory: 4Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apex-alwayson-controller
  namespace: apex-build
spec:
  replicas: 2
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: apex-backend
  namespace: apex-build
spec:
  minReplicas: 4
  maxReplicas: 20
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: apex-frontend
  namespace: apex-build
spec:
  minReplicas: 4
  maxReplicas: 12
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: apex-ingress
  namespace: apex-build
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
